# Running Magma Auto-Sale Script with systemd

This document outlines how to run the `magma_sale_process.py` script as a persistent background service using `systemd` on a Linux system. This ensures the script automatically starts on boot and restarts if it encounters issues.

## Prerequisites

1.  **Python 3:** Ensure Python 3 and `pip` are installed on your system.
2.  **Required Python Packages:** Install the necessary packages:
    ```bash
    pip install pyTelegramBotAPI requests schedule
    ```
3.  **Script Location:** Place the `Magma/` directory (containing `magma_sale_process.py`) in a suitable location on your server, for example, `/opt/lightning-tools/Magma/`.
4.  **Configuration File:**
    *   Copy `config.ini.example` to `config.ini`.
    *   Place `config.ini` in the directory **parent** to the `Magma` directory (e.g., `/opt/lightning-tools/config.ini` if the script is in `/opt/lightning-tools/Magma/`).
    *   Fill in all required details in `config.ini` (API tokens, Telegram bot info, LND/BOS paths, etc.).
5.  **LND & BOS (Optional):** Ensure `lncli` (and `bos` if used) are accessible, either in the system's PATH or by providing the full path in `config.ini`.
6.  **Log Directory:** The script will attempt to create a `logs` directory in its parent directory (e.g., `/opt/lightning-tools/logs/`). Ensure the user running the script has write permissions there.

## systemd Service File

Create a systemd service file to manage the script.

1.  **Create the service file:**
    Open a new file named `magma-sale.service` in `/etc/systemd/system/`:
    ```bash
    sudo nano /etc/systemd/system/magma-sale.service
    ```

2.  **Paste the following content:**
    Adjust `User`, `Group`, `WorkingDirectory`, and `ExecStart` paths according to your setup.

    ```ini
    [Unit]
    Description=Magma Channel Auto-Sale Service
    After=network.target LND.service # Add other dependencies if LND runs as a service

    [Service]
    Type=simple
    User=your_username # Replace with the user that should run the script
    Group=your_groupname # Replace with the group for the user

    # Set the working directory to the parent of the Magma script directory
    # This ensures relative paths like ../config.ini and ../logs/ work correctly.
    # Example: if script is /opt/lightning-tools/Magma/magma_sale_process.py
    # then WorkingDirectory should be /opt/lightning-tools/
    WorkingDirectory=/opt/lightning-tools/

    # Path to your Python interpreter and the script
    ExecStart=/usr/bin/python3 /opt/lightning-tools/Magma/magma_sale_process.py

    Restart=always
    RestartSec=10
    StandardOutput=journal
    StandardError=journal
    SyslogIdentifier=magma-sale

    [Install]
    WantedBy=multi-user.target
    ```

    **Notes on the service file:**
    *   `User` and `Group`: It's recommended to run services under a dedicated non-root user.
    *   `WorkingDirectory`: Crucial for the script to find `config.ini` and the `logs` directory. If your script is at `/home/admin/tools/Lightning-Python-Tools/Magma/magma_sale_process.py`, then `WorkingDirectory` should be `/home/admin/tools/Lightning-Python-Tools/`.
    *   `ExecStart`: Ensure the path to `python3` and your script is correct.
    *   `After=network.target LND.service`: If your LND node runs as a systemd service (e.g., `LND.service`), adding it here ensures Magma starts after LND. Adjust service name if needed.
    *   `Restart=always`: Ensures the script restarts automatically.
    *   `StandardOutput=journal` and `StandardError=journal`: Directs script output to the systemd journal.

3.  **Save and close the file.**

## Enabling and Managing the Service

1.  **Reload systemd daemon:**
    This makes systemd aware of the new service file.
    ```bash
    sudo systemctl daemon-reload
    ```

2.  **Enable the service:**
    This makes the service start automatically on boot.
    ```bash
    sudo systemctl enable magma-sale.service
    ```

3.  **Start the service:**
    ```bash
    sudo systemctl start magma-sale.service
    ```

4.  **Check the status of the service:**
    ```bash
    sudo systemctl status magma-sale.service
    ```
    You should see output indicating the service is active (running).

5.  **View logs:**
    To view the logs generated by the script (which are now directed to the journal):
    ```bash
    sudo journalctl -u magma-sale.service -f
    ```
    (Use `-f` to follow the logs in real-time. Remove `-f` to see all past logs. Add `-n LINES` (e.g., `-n 100`) to see the last N lines.)

## Stopping or Restarting the Service

*   **To stop the service:**
    ```bash
    sudo systemctl stop magma-sale.service
    ```
*   **To restart the service (e.g., after updating the script or config.ini):**
    ```bash
    sudo systemctl restart magma-sale.service
    ```

This setup provides a robust way to run your Magma auto-sale script. Remember to adjust paths and usernames in the example service file to match your specific environment.
